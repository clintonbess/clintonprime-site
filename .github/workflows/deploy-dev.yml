name: Deploy (Dev) — Server Build + Minimal Deploy
on:
  push:
    branches: [dev]
  workflow_dispatch:

# Keep newest run; auto-cancel older ones
concurrency:
  group: deploy-dev-build-only
  cancel-in-progress: true

env:
  WEB_ROOT: /var/www/html/clintonprime
  CURRENT_API: /opt/clintonprime-site/current-api
  PM2_NAME: clintonprime-api-dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: dev # access environment-scoped SSH secrets

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm (for web build on runner)
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ---------- WEB (build on runner) ----------
      - name: Install & Build Web
        working-directory: apps/web
        run: |
          pnpm install
          pnpm build
          test -f dist/index.html

      - name: Package Web Dist
        run: tar -C apps/web -czf web-dist.tar.gz dist

      # ---------- API (build on runner; ship runtime-ready) ----------
      - name: Install & Build API
        working-directory: libs/api
        run: |
          pnpm install
          pnpm build
          ls -lah dist
          test -f dist/index.js

      - name: Package API Runtime (dist + node_modules + package.json)
        run: tar -C libs/api -czf api-runtime.tar.gz dist node_modules package.json

      # ---------- VERIFY ----------
      - name: Verify archives exist
        run: ls -lh web-dist.tar.gz api-runtime.tar.gz

      # ---------- SECRETS PREFLIGHT ----------
      - name: Secrets preflight
        run: |
          [ -n "${{ secrets.LIGHTSAIL_HOST_DEV }}" ] || (echo "LIGHTSAIL_HOST_DEV missing" && exit 1)
          [ -n "${{ secrets.LIGHTSAIL_USER_DEV }}" ] || (echo "LIGHTSAIL_USER_DEV missing" && exit 1)
          [ -n "${{ secrets.LIGHTSAIL_SSH_KEY_DEV }}" ] || (echo "LIGHTSAIL_SSH_KEY_DEV missing" && exit 1)

      # ---------- UPLOAD TO SERVER /tmp ----------
      - name: Upload archives to server (/tmp)
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.LIGHTSAIL_HOST_DEV }}
          username: ${{ secrets.LIGHTSAIL_USER_DEV }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY_DEV }}
          source: "web-dist.tar.gz,api-runtime.tar.gz"
          target: /tmp/
          debug: true

      # ---------- DEPLOY (copy web to WEB_ROOT, copy api to CURRENT_API, write .env, start PM2) ----------
      - name: Deploy to server and start PM2 (MVP)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.LIGHTSAIL_HOST_DEV }}
          username: ${{ secrets.LIGHTSAIL_USER_DEV }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY_DEV }}
          script_stop: true
          script: |
            set -euo pipefail
            WEB_ROOT="${{ env.WEB_ROOT }}"
            CURRENT_API="${{ env.CURRENT_API }}"
            PM2_NAME="${{ env.PM2_NAME }}"
            SHA="${{ github.sha }}"
            WORK="/tmp/cp-build-${SHA:0:12}"
            OWNER="$(whoami)"
            PORT=3000
            NODE_ENV=production
            export PORT NODE_ENV

            echo "[server] prepare workdir: $WORK"
            rm -rf "$WORK"
            mkdir -p "$WORK/web" "$WORK/api"

            echo "[server] unpacking artifacts"
            tar -xzf /tmp/web-dist.tar.gz -C "$WORK/web"
            tar -xzf /tmp/api-runtime.tar.gz -C "$WORK/api"
            rm -f /tmp/web-dist.tar.gz /tmp/api-runtime.tar.gz

            echo "[server] ensure tools"
            sudo apt-get update -y
            sudo apt-get install -y rsync curl
            if ! command -v pm2 >/dev/null 2>&1; then
              sudo npm i -g pm2
            fi
            export PATH="$(npm config get prefix 2>/dev/null)/bin:/usr/local/bin:$PATH"
            echo "[server] pm2 path: $(command -v pm2 || echo 'not found')"

            echo "[server] deploy web -> $WEB_ROOT"
            sudo mkdir -p "$WEB_ROOT"
            sudo rsync -a --delete "$WORK/web/dist/" "$WEB_ROOT/"
            sudo chown -R www-data:www-data "$WEB_ROOT"
            if command -v nginx >/dev/null 2>&1; then
              sudo nginx -t && sudo systemctl reload nginx || true
            fi

            echo "[server] deploy api -> $CURRENT_API"
            sudo mkdir -p "$CURRENT_API"
            sudo rsync -a --delete "$WORK/api/" "$CURRENT_API/"
            sudo chown -R "$OWNER:$OWNER" "$CURRENT_API"

            echo "[server] build .env (reuse existing tokens if secrets are blank)"
            # pull tokens from secrets first
            REF_SEC="${{ secrets.SPOTIFY_REFRESH_TOKEN_DEV }}"
            ACC_SEC="${{ secrets.SPOTIFY_ACCESS_TOKEN_DEV }}"
            REF_VAL="$REF_SEC"
            ACC_VAL="$ACC_SEC"
            # fallback to existing file values if secrets empty
            if [ -z "$REF_VAL" ] && [ -f "$CURRENT_API/.env" ]; then
              REF_VAL="$(sed -n 's/^SPOTIFY_REFRESH_TOKEN=//p' "$CURRENT_API/.env" | head -n1 || true)"
              [ -n "$REF_VAL" ] && echo "[server] reusing existing SPOTIFY_REFRESH_TOKEN"
            fi
            if [ -z "$ACC_VAL" ] && [ -f "$CURRENT_API/.env" ]; then
              ACC_VAL="$(sed -n 's/^SPOTIFY_ACCESS_TOKEN=//p' "$CURRENT_API/.env" | head -n1 || true)"
              [ -n "$ACC_VAL" ] && echo "[server] reusing existing SPOTIFY_ACCESS_TOKEN"
            fi

            # write merged env atomically
            ENV_TMP="$WORK/.env.tmp"
            {
              echo "NODE_ENV=production"
              echo "PORT=3000"
              echo "PUBLIC_BASE_URL=https://dev.clintonprime.com"
              echo
              echo "SESSION_SECRET=${{ secrets.SESSION_SECRET_DEV }}"
              echo
              echo "SPOTIFY_CLIENT_ID=${{ secrets.SPOTIFY_CLIENT_ID_DEV }}"
              echo "SPOTIFY_CLIENT_SECRET=${{ secrets.SPOTIFY_CLIENT_SECRET_DEV }}"
              echo "SPOTIFY_REDIRECT_URI=https://dev.clintonprime.com/api/spotify/callback"
              echo "SPOTIFY_REFRESH_TOKEN=${REF_VAL}"
              echo "SPOTIFY_ACCESS_TOKEN=${ACC_VAL}"
            } > "$ENV_TMP"
            mv "$ENV_TMP" "$CURRENT_API/.env"
            chmod 600 "$CURRENT_API/.env"

            echo "[server] preflight: run API directly on :$PORT"
            ( PORT=$PORT NODE_ENV=$NODE_ENV node "$CURRENT_API/dist/index.js" & echo $! > "$WORK/test.pid" )
            sleep 2
            curl -fsS "http://127.0.0.1:$PORT/" >/dev/null || (echo "[server] direct node preflight FAILED"; kill "$(cat "$WORK/test.pid")" 2>/dev/null || true; exit 1)
            kill "$(cat "$WORK/test.pid")" 2>/dev/null || true

            echo "[server] start PM2 fresh on :$PORT (cwd=$CURRENT_API)"
            pm2 delete "$PM2_NAME" >/dev/null 2>&1 || true
            PORT=$PORT NODE_ENV=$NODE_ENV pm2 start "$CURRENT_API/dist/index.js" --name "$PM2_NAME" --time --cwd "$CURRENT_API"

            echo "[server] wait and check PM2 status"
            sleep 4
            pm2 status || true
            pm2 describe "$PM2_NAME" || true
            if ! pm2 status "$PM2_NAME" | grep -q "online"; then
              echo "[server] pm2 process not online, showing last logs…"
              pm2 logs "$PM2_NAME" --lines 200 --nostream || true
              # Uncomment to hard-fail if PM2 isn't online:
              # exit 1
            fi

            pm2 save || true
            echo "✅ Deployed web to $WEB_ROOT, merged $CURRENT_API/.env (tokens preserved), and PM2 '$PM2_NAME' started on :$PORT"
